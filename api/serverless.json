{
    "service": {
        "name": "helloWorld"
    },
    "custom": {
        "webpack": {
            "webpackConfig": "./webpack.serverless.config.js",
            "includeModules": {
                "forceExclude": ["aws-sdk"]
            }
        },
        "defaultStage": "dev",
        "currentStage": "${opt:stage, self:custom.defaultStage}",
        "MEDIA_CONVERT_TEMPLATE": "1080p"
    },
    "plugins": [
        "serverless-webpack",
        "serverless-offline",
        "serverless-dotenv-plugin",
        "serverless-pseudo-parameters"
    ],
    "provider": {
        "name": "aws",
        "runtime": "nodejs12.x",
        "stage": "${self:custom.currentStage}",
        "timeout": 20,
        "region": "eu-west-1",
        "apiGateway": {
            "minimumCompressionSize": 1024
        },
        "environment": {
            "AWS_NODEJS_CONNECTION_REUSE_ENABLED": 1,
            "STAGE": "${self:custom.currentStage}"
        },
        "iamRoleStatements": [
            {
                "Effect": "Allow",
                "Action": [
                    "s3:GetBucketNotification",
                    "s3:PutBucketNotification"
                ],
                "Resource": {
                    "Fn::Join": ["", ["*"]]
                }
            }
        ]
    },
    "functions": {
        "handler": {
            "handler": "handler.handler",
            "events": [
                {
                    "http": {
                        "method": "get",
                        "path": "test"
                    }
                }
            ]
        },
        "ingress": {
            "handler": "ingress.handler",
            "role": "IngressRole",
            "environment": {
                "MEDIA_CONVERT_ROLE": {
                    "Fn::GetAtt": ["MediaConvertRole", "Arn"]
                },
                "MEDIA_CONVERT_TEMPLATE": "${self:custom.MEDIA_CONVERT_TEMPLATE}"
            },
            "events": [
                {
                    "s3": {
                        "bucket": "#{AWS::AccountId}-${self:custom.currentStage}-video-input",
                        "event": "s3:ObjectCreated:*",
                        "existing": true
                    }
                }
            ]
        }
    },
    "resources": {
        "Resources": {
            "InputBucket": {
                "Type": "AWS::S3::Bucket",
                "Properties": {
                    "BucketName": "#{AWS::AccountId}-${self:custom.currentStage}-video-input",
                    "CorsConfiguration": {
                        "CorsRules": [
                            {
                                "AllowedOrigins": ["*"],
                                "AllowedHeaders": ["*"],
                                "AllowedMethods": [
                                    "GET",
                                    "PUT",
                                    "POST",
                                    "DELETE",
                                    "HEAD"
                                ],
                                "MaxAge": 3000
                            }
                        ]
                    }
                }
            },
            "OutputBucket": {
                "Type": "AWS::S3::Bucket",
                "Properties": {
                    "BucketName": "#{AWS::AccountId}-${self:custom.currentStage}-video-output",
                    "CorsConfiguration": {
                        "CorsRules": [
                            {
                                "AllowedOrigins": ["*"],
                                "AllowedHeaders": ["*"],
                                "AllowedMethods": [
                                    "GET",
                                    "PUT",
                                    "POST",
                                    "DELETE",
                                    "HEAD"
                                ],
                                "MaxAge": 3000
                            }
                        ]
                    }
                }
            },
            "MediaConvert": {
                "Type": "AWS::MediaConvert::JobTemplate",
                "Properties": {
                    "Category": "1080p",
                    "Description": "1080p",
                    "Name": "${self:custom.MEDIA_CONVERT_TEMPLATE}",
                    "SettingsJson": "${file(mediaConvertTemplate.js):settings}"
                }
            },
            "IngressRole": {
                "Type": "AWS::IAM::Role",
                "Properties": {
                    "RoleName": "${self:service.name}-${self:custom.currentStage}-ingressRole",
                    "AssumeRolePolicyDocument": {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Effect": "Allow",
                                "Principal": {
                                    "Service": ["lambda.amazonaws.com"]
                                },
                                "Action": "sts:AssumeRole"
                            }
                        ]
                    },
                    "Policies": [
                        {
                            "PolicyName": "${self:service.name}-${self:custom.currentStage}-ingressRole-Policy",
                            "PolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Action": [
                                            "logs:CreateLogStream",
                                            "logs:CreateLogGroup",
                                            "logs:PutLogEvents"
                                        ],
                                        "Resource": "*",
                                        "Effect": "Allow"
                                    },
                                    {
                                        "Action": [
                                            "s3:GetBucketNotification",
                                            "s3:PutBucketNotification"
                                        ],
                                        "Resource": "*",
                                        "Effect": "Allow"
                                    },
                                    {
                                        "Effect": "Allow",
                                        "Action": [
                                            "iam:GetRole",
                                            "iam:PassRole"
                                        ],
                                        "Resource": "*"
                                    },
                                    {
                                        "Effect": "Allow",
                                        "Action": ["mediaconvert:*"],
                                        "Resource": ["*"]
                                    }
                                ]
                            }
                        }
                    ]
                }
            },
            "MediaConvertRole": {
                "Type": "AWS::IAM::Role",
                "Properties": {
                    "RoleName": "${self:service.name}-${self:custom.currentStage}-MediaConvertRole",
                    "AssumeRolePolicyDocument": {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Effect": "Allow",
                                "Principal": {
                                    "Service": [
                                        "mediaconvert.amazonaws.com",
                                        "mediaconvert.us-east-1.amazonaws.com",
                                        "mediaconvert.ap-northeast-1.amazonaws.com",
                                        "mediaconvert.ap-southeast-1.amazonaws.com",
                                        "mediaconvert.ap-southeast-2.amazonaws.com",
                                        "mediaconvert.eu-central-1.amazonaws.com",
                                        "mediaconvert.eu-west-1.amazonaws.com",
                                        "mediaconvert.us-east-1.amazonaws.com",
                                        "mediaconvert.us-west-1.amazonaws.com",
                                        "mediaconvert.us-west-2.amazonaws.com"
                                    ]
                                },
                                "Action": ["sts:AssumeRole"]
                            }
                        ]
                    },
                    "Policies": [
                        {
                            "PolicyName": "${self:service.name}-${self:custom.currentStage}-MediaConvertPolicy",
                            "PolicyDocument": {
                                "Version": "2012-10-17",
                                "Statement": [
                                    {
                                        "Effect": "Allow",
                                        "Action": ["s3:*"],
                                        "Resource": ["*"]
                                    },
                                    {
                                        "Effect": "Allow",
                                        "Action": [
                                            "autoscaling:Describe*",
                                            "cloudwatch:*",
                                            "logs:*",
                                            "sns:*"
                                        ],
                                        "Resource": ["*"]
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        }
    }
}
