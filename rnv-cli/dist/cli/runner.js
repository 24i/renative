var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.PIPES=void 0;var _path=_interopRequireDefault(require("path"));var _fs=_interopRequireDefault(require("fs"));var _shelljs=_interopRequireDefault(require("shelljs"));var _common=require("../common");var _constants=require("../constants");var _exec=require("../exec");var _apple=require("../platformTools/apple");var _web=require("../platformTools/web");var _tizen=require("../platformTools/tizen");var _webos=require("../platformTools/webos");var _firefox=require("../platformTools/firefox");var _electron=require("../platformTools/electron");var _buildHooks=require("../buildHooks");var _android=require("../platformTools/android");var _app=_interopRequireWildcard(require("./app"));var RUN='run';var LOG='log';var START='start';var PACKAGE='package';var BUILD='build';var DEPLOY='deploy';var UPDATE='update';var EXPORT='export';var TEST='test';var DOC='doc';var UNINSTALL='uninstall';var PIPES={RUN_BEFORE:'run:before',RUN_AFTER:'run:after',LOG_BEFORE:'log:before',LOG_AFTER:'log:after',START_BEFORE:'start:before',START_AFTER:'start:after',PACKAGE_BEFORE:'package:before',PACKAGE_AFTER:'package:after',EXPORT_BEFORE:'export:before',EXPORT_AFTER:'export:after',BUILD_BEFORE:'build:before',BUILD_AFTER:'build:after',DEPLOY_BEFORE:'deploy:before',DEPLOY_AFTER:'deploy:after'};exports.PIPES=PIPES;var run=function run(c){(0,_common.logTask)('run');switch(c.command){case RUN:return _runApp(c);break;case START:return _start(c);break;case EXPORT:return _exportApp(c);break;case PACKAGE:return _packageApp(c);break;case BUILD:return _buildApp(c);break;case LOG:return _log(c);break;case DEPLOY:return _deployApp(c);break;default:return Promise.reject("Command "+c.command+" not supported");}};var _start=function _start(c,platform){return new Promise(function(resolve,reject){var platform=c.platform;var port=c.program.port||c.defaultPorts[platform];(0,_common.logTask)("_start:"+platform+":"+port);switch(platform){case _constants.MACOS:case _constants.WINDOWS:(0,_buildHooks.executePipe)(c,PIPES.START_BEFORE).then(function(){return(0,_electron.runElectronDevServer)(c,platform,port);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.START_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.WEB:case _constants.TIZEN:case _constants.WEBOS:(0,_buildHooks.executePipe)(c,PIPES.START_BEFORE).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_web.runWebDevServer)(c,platform,port);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.START_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;}if(c.program.reset){_shelljs.default.exec('node ./node_modules/react-native/local-cli/cli.js start --reset-cache');}else{_shelljs.default.exec('node ./node_modules/react-native/local-cli/cli.js start');}});};var _runApp=function _runApp(c){return new Promise(function(resolve,reject){(0,_common.logTask)("_runApp:"+c.platform);(0,_common.isPlatformSupported)(c).then(function(v){return _runAppWithPlatform(c);}).catch(function(e){return reject(e);});});};var _runAppWithPlatform=function _runAppWithPlatform(c){return new Promise(function(resolve,reject){var platform=c.platform;var port=c.program.port||c.defaultPorts[platform];var target=c.program.target||c.globalConfig.defaultTargets[platform];(0,_common.logTask)("_runAppWithPlatform:"+platform+":"+port);switch(platform){case _constants.IOS:case _constants.TVOS:(0,_buildHooks.executePipe)(c,PIPES.RUN_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_apple.prepareXcodeProject)(c,platform);}).then(function(){return(0,_apple.runXcodeProject)(c,platform,target);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.RUN_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.ANDROID:case _constants.ANDROID_TV:case _constants.ANDROID_WEAR:if(!(0,_common.checkSdk)(c,platform,reject))return;(0,_buildHooks.executePipe)(c,PIPES.RUN_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_android.configureAndroidProperties)(c);}).then(function(){return(0,_android.configureGradleProject)(c,platform);}).then(function(){return _runAndroid(c,platform,target,platform===_constants.ANDROID_WEAR);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.RUN_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.MACOS:case _constants.WINDOWS:(0,_buildHooks.executePipe)(c,PIPES.RUN_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_electron.runElectron)(c,platform,port);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.RUN_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.WEB:(0,_buildHooks.executePipe)(c,PIPES.RUN_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_web.runWeb)(c,platform,port);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.RUN_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.TIZEN:case _constants.TIZEN_WATCH:if(!(0,_common.checkSdk)(c,platform,reject))return;(0,_buildHooks.executePipe)(c,PIPES.RUN_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_tizen.runTizen)(c,platform,target);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.RUN_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.WEBOS:if(!(0,_common.checkSdk)(c,platform,reject))return;(0,_buildHooks.executePipe)(c,PIPES.RUN_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_webos.runWebOS)(c,platform,target);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.RUN_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.KAIOS:case _constants.FIREFOX_OS:case _constants.FIREFOX_TV:if(platform===_constants.KAIOS&&!(0,_common.checkSdk)(c,platform,reject))return;(0,_buildHooks.executePipe)(c,PIPES.RUN_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_firefox.runFirefoxProject)(c,platform);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.RUN_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;}(0,_common.logErrorPlatform)(platform,resolve);});};var _packageApp=function _packageApp(c){return new Promise(function(resolve,reject){(0,_common.logTask)("_packageApp:"+c.platform);(0,_common.isPlatformSupported)(c).then(function(v){return _packageAppWithPlatform(c);}).catch(function(e){return reject(e);});});};var _packageAppWithPlatform=function _packageAppWithPlatform(c){return new Promise(function(resolve,reject){(0,_common.logTask)("_packageAppWithPlatform:"+c.platform);var platform=c.platform;var target=c.program.target||c.globalConfig.defaultTargets[platform];switch(platform){case _constants.IOS:case _constants.TVOS:(0,_buildHooks.executePipe)(c,PIPES.PACKAGE_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_apple.packageBundleForXcode)(c,platform);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.PACKAGE_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.ANDROID:case _constants.ANDROID_TV:case _constants.ANDROID_WEAR:if(!(0,_common.checkSdk)(c,platform,reject))return;(0,_buildHooks.executePipe)(c,PIPES.PACKAGE_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_android.configureAndroidProperties)(c);}).then(function(){return(0,_android.configureGradleProject)(c,platform);}).then(function(){return(0,_android.packageAndroid)(c,platform,target,platform===_constants.ANDROID_WEAR);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.PACKAGE_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;}(0,_common.logErrorPlatform)(platform,resolve);});};var _exportApp=function _exportApp(c){return new Promise(function(resolve,reject){(0,_common.logTask)("_exportApp:"+c.platform);(0,_common.isPlatformSupported)(c).then(function(v){return _exportAppWithPlatform(c);}).catch(function(e){return reject(e);});});};var _exportAppWithPlatform=function _exportAppWithPlatform(c){return new Promise(function(resolve,reject){(0,_common.logTask)("_exportAppWithPlatform:"+c.platform);var platform=c.platform;switch(platform){case _constants.IOS:case _constants.TVOS:(0,_buildHooks.executePipe)(c,PIPES.EXPORT_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_apple.prepareXcodeProject)(c,platform);}).then(function(){return(0,_apple.packageBundleForXcode)(c,platform);}).then(function(){return(0,_apple.archiveXcodeProject)(c,platform);}).then(function(){return(0,_apple.exportXcodeProject)(c,platform);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.EXPORT_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;}(0,_common.logErrorPlatform)(platform,resolve);});};var _deployApp=function _deployApp(c){return new Promise(function(resolve,reject){(0,_common.logTask)("_deployApp:"+c.platform);var platform=c.platform;if(!(0,_common.isPlatformSupportedSync)(platform,null,reject))return;(0,_buildHooks.executePipe)(c,PIPES.DEPLOY_BEFORE).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.DEPLOY_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;(0,_common.logErrorPlatform)(platform,resolve);});};var _buildApp=function _buildApp(c){return new Promise(function(resolve,reject){(0,_common.logTask)("_buildApp:"+c.platform);(0,_common.isPlatformSupported)(c).then(function(v){return _buildAppWithPlatform(c);}).catch(function(e){return reject(e);});});};var _buildAppWithPlatform=function _buildAppWithPlatform(c){return new Promise(function(resolve,reject){(0,_common.logTask)("_buildAppWithPlatform:"+c.platform);var platform=c.platform;switch(platform){case _constants.ANDROID:case _constants.ANDROID_TV:case _constants.ANDROID_WEAR:(0,_buildHooks.executePipe)(c,PIPES.BUILD_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_android.configureAndroidProperties)(c);}).then(function(){return(0,_android.configureGradleProject)(c,platform);}).then(function(){return(0,_android.packageAndroid)(c,platform);}).then(function(){return(0,_android.buildAndroid)(c,platform);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.BUILD_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.MACOS:case _constants.WINDOWS:(0,_buildHooks.executePipe)(c,PIPES.RUN_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_electron.buildElectron)(c,platform);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.RUN_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.IOS:case _constants.TVOS:(0,_buildHooks.executePipe)(c,PIPES.BUILD_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_apple.prepareXcodeProject)(c,platform);}).then(function(){return(0,_apple.packageBundleForXcode)(c,platform);}).then(function(){return(0,_apple.archiveXcodeProject)(c,platform);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.BUILD_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.WEB:(0,_buildHooks.executePipe)(c,PIPES.BUILD_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_web.buildWeb)(c,platform);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.BUILD_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.KAIOS:case _constants.FIREFOX_OS:case _constants.FIREFOX_TV:(0,_buildHooks.executePipe)(c,PIPES.BUILD_BEFORE).then(function(){return(0,_common.cleanPlatformIfRequired)(c,platform);}).then(function(){return(0,_common.configureIfRequired)(c,platform);}).then(function(){return(0,_firefox.buildFirefoxProject)(c,platform);}).then(function(){return(0,_buildHooks.executePipe)(c,PIPES.BUILD_AFTER);}).then(function(){return resolve();}).catch(function(e){return reject(e);});return;}(0,_common.logErrorPlatform)(platform,resolve);});};var _log=function _log(c){return new Promise(function(resolve,reject){(0,_common.logTask)('_log');var platform=c.platform;if(!(0,_common.isPlatformSupportedSync)(platform,null,reject))return;switch(platform){case _constants.IOS:case _constants.TVOS:(0,_apple.runAppleLog)(c,platform).then(function(){return resolve();}).catch(function(e){return reject(e);});return;case _constants.ANDROID:case _constants.ANDROID_TV:case _constants.ANDROID_WEAR:(0,_android.runAndroidLog)(c,platform).then(function(){return resolve();}).catch(function(e){return reject(e);});return;}(0,_common.logErrorPlatform)(platform,resolve);});};var _runAndroid=function _runAndroid(c,platform,target,forcePackage){return new Promise(function(resolve,reject){(0,_common.logTask)("_runAndroid:"+platform);var appFolder=(0,_common.getAppFolder)(c,platform);if(c.appConfigFile.platforms.android.runScheme==='Release'||forcePackage){(0,_android.packageAndroid)(c,platform).then(function(){(0,_android.runAndroid)(c,platform,target).then(function(){return resolve();}).catch(function(e){return reject(e);});});}else{(0,_android.runAndroid)(c,platform,target).then(function(){return resolve();}).catch(function(e){return reject(e);});}});};var _default=run;exports.default=_default;